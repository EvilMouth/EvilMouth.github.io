{"componentChunkName":"component---src-templates-blog-post-js","path":"/bubble-of-seekbar/","result":{"data":{"site":{"siteMetadata":{"title":"Evil Mouth","author":{"name":"Evil Mouth"}}},"markdownRemark":{"id":"8b7e653c-3bf9-58eb-911b-ee5c8aa048f0","excerpt":"…","html":"<p>最近的项目需要做聊天语音消息，自然是用<code class=\"language-text\">SeekBar</code>实现进度条，这个倒不难，播放拖动进度等功能。但是设计师要拖动进度的同时<code class=\"language-text\">thumb</code>上方显示一个气泡显示秒数，效果如下\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/7f7468213b2caaab85b8061bf0c2fa89/3f513/1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3aAH/8QAFRABAQAAAAAAAAAAAAAAAAAAECH/2gAIAQEAAQUCr//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABcQAQADAAAAAAAAAAAAAAAAAAEQUaH/2gAIAQEAAT8haGz/AP/aAAwDAQACAAMAAAAQc8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAYEAACAwAAAAAAAAAAAAAAAAAQMREhYf/aAAgBAQABPxBEDvB//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/7f7468213b2caaab85b8061bf0c2fa89/1c72d/1.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/7f7468213b2caaab85b8061bf0c2fa89/a80bd/1.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/7f7468213b2caaab85b8061bf0c2fa89/1c91a/1.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/7f7468213b2caaab85b8061bf0c2fa89/1c72d/1.jpg 590w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/7f7468213b2caaab85b8061bf0c2fa89/a8a14/1.jpg 885w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/7f7468213b2caaab85b8061bf0c2fa89/3f513/1.jpg 1096w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>毕竟<code class=\"language-text\">SeekBar</code>没提供这个功能，所以首先想到的是自定义<code class=\"language-text\">View</code>，然后重写<code class=\"language-text\">onTouch</code>滑动显示气泡，气泡也属于自定义<code class=\"language-text\">View</code>里面，但是这样有个问题，由于气泡包在自定义<code class=\"language-text\">View</code>里面，所以控件高度不会是设计师要的效果，所以想到了<code class=\"language-text\">Window</code>。跟<code class=\"language-text\">Dialog</code>、<code class=\"language-text\">Toast</code>类似。</p>\n<!-- More -->\n<p>首先实现气泡，原理是在需要的时候向<code class=\"language-text\">WindowManager</code>请求添加一个<code class=\"language-text\">View</code>到窗口并及时更新气泡的位置</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">WindowManager</span> windowManager <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">)</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getSystemService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span>WINDOW_SERVICE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span> layoutParams <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nlayoutParams <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nlayoutParams<span class=\"token punctuation\">.</span>gravity <span class=\"token operator\">=</span> <span class=\"token class-name\">Gravity</span><span class=\"token punctuation\">.</span>START <span class=\"token operator\">|</span> <span class=\"token class-name\">Gravity</span><span class=\"token punctuation\">.</span>TOP<span class=\"token punctuation\">;</span>\nlayoutParams<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token class-name\">ViewGroup</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>WRAP_CONTENT<span class=\"token punctuation\">;</span>\nlayoutParams<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token class-name\">ViewGroup</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>WRAP_CONTENT<span class=\"token punctuation\">;</span>\nlayoutParams<span class=\"token punctuation\">.</span>format <span class=\"token operator\">=</span> <span class=\"token class-name\">PixelFormat</span><span class=\"token punctuation\">.</span>TRANSLUCENT<span class=\"token punctuation\">;</span>\nlayoutParams<span class=\"token punctuation\">.</span>flags <span class=\"token operator\">=</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>FLAG_NOT_TOUCH_MODAL <span class=\"token operator\">|</span>\n        <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>FLAG_NOT_FOCUSABLE <span class=\"token operator\">|</span>\n        <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>FLAG_SHOW_WHEN_LOCKED<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">XiaoMiUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isMIUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token class-name\">Build</span><span class=\"token punctuation\">.</span>VERSION<span class=\"token punctuation\">.</span>SDK_INT <span class=\"token operator\">>=</span> <span class=\"token class-name\">Build</span><span class=\"token punctuation\">.</span>VERSION_CODES<span class=\"token punctuation\">.</span>N_MR1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    layoutParams<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>TYPE_APPLICATION<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    layoutParams<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>TYPE_TOAST<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>FLAG<em>NOT</em>TOUCH<em>MODAL : 当前 Window 区域以外的单击事件传递给底层 Window，不拦截，一般需要开启此标记\nFLAG</em>NOT<em>FOCUSABLE : 不需要获取焦点\nFLAG</em>SHOW<em>WHEN</em>LOCKED : 显示在锁屏上\nXiaoMiUtils.isMIUI() : 由于小米对 TYPE_TOAST 管制比较严，在有些小米手机会显示不了</p>\n</blockquote>\n<p>并在适当的时候调用</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">windowManager<span class=\"token punctuation\">.</span><span class=\"token function\">addView</span><span class=\"token punctuation\">(</span>bubbleView<span class=\"token punctuation\">,</span> layoutParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwindowManager<span class=\"token punctuation\">.</span><span class=\"token function\">updateViewLayout</span><span class=\"token punctuation\">(</span>bubbleView<span class=\"token punctuation\">,</span> layoutParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwindowManager<span class=\"token punctuation\">.</span><span class=\"token function\">removeViewImmediate</span><span class=\"token punctuation\">(</span>bubbleView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>最难的部分气泡的显示其实一点也不难，在适当的时候也就是<code class=\"language-text\">onTouch</code>的事件处理时调用而已，这样气泡功能就实现了。</p>\n<h3>但是</h3>\n<p>哈哈，自定义<code class=\"language-text\">View</code>不是我想要的，这样做侵入性很强，说不定以后设计师改了个样式就麻烦了，所以就要改到<code class=\"language-text\">SeekBar</code>。既然这样干脆不要自定义<code class=\"language-text\">View</code>，我就想到了<code class=\"language-text\">SeekBar</code>本身提供的<code class=\"language-text\">setOnSeekBarChangeListener</code>，里面有三个回调</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">OnSeekBarChangeListener</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">onProgressChanged</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span> var1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> var2<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> var3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">void</span> <span class=\"token function\">onStartTrackingTouch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span> var1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">void</span> <span class=\"token function\">onStopTrackingTouch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span> var1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>简直完美符合我的思路，在<code class=\"language-text\">onStartTrackingTouch</code>的时候<code class=\"language-text\">addView</code>，在<code class=\"language-text\">onStopTrackingTouch</code>的时候<code class=\"language-text\">removeViewImmediate</code>，在滑动过程中，也就是<code class=\"language-text\">onProgressChanged</code>的时候<code class=\"language-text\">updateViewLayout</code>更新气泡位置，这样做完全不会影响到项目原有的代码，只需要注入气泡显示的代码即可。</p>\n<p>于是有了下面的<code class=\"language-text\">Delegate</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SeekBarBubbleDelegate</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">SeekBar</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">OnSeekBarChangeListener</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">/**\n     * 气泡\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">View</span> mBubble<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> mIsDragging<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">WindowManager</span> mWindowManager<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span> mLayoutParams<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/**\n     * 气泡移动范围\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Rect</span> mRect<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/**\n     * 状态栏高度\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> mStatusBarHeight<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SeekBar</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">OnSeekBarChangeListener</span><span class=\"token punctuation\">></span></span> mListeners<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">SeekBarBubbleDelegate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">View</span> bubble<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mBubble <span class=\"token operator\">=</span> bubble<span class=\"token punctuation\">;</span>\n        mBubble<span class=\"token punctuation\">.</span><span class=\"token function\">setVisibility</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">View</span><span class=\"token punctuation\">.</span>INVISIBLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mIsDragging <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n        mWindowManager <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">)</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getSystemService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span>WINDOW_SERVICE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mLayoutParams <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mLayoutParams<span class=\"token punctuation\">.</span>gravity <span class=\"token operator\">=</span> <span class=\"token class-name\">Gravity</span><span class=\"token punctuation\">.</span>START <span class=\"token operator\">|</span> <span class=\"token class-name\">Gravity</span><span class=\"token punctuation\">.</span>TOP<span class=\"token punctuation\">;</span>\n        mLayoutParams<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> <span class=\"token class-name\">ViewGroup</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>WRAP_CONTENT<span class=\"token punctuation\">;</span>\n        mLayoutParams<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> <span class=\"token class-name\">ViewGroup</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>WRAP_CONTENT<span class=\"token punctuation\">;</span>\n        mLayoutParams<span class=\"token punctuation\">.</span>format <span class=\"token operator\">=</span> <span class=\"token class-name\">PixelFormat</span><span class=\"token punctuation\">.</span>TRANSLUCENT<span class=\"token punctuation\">;</span>\n        mLayoutParams<span class=\"token punctuation\">.</span>flags <span class=\"token operator\">=</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>FLAG_NOT_TOUCH_MODAL <span class=\"token operator\">|</span>\n                <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>FLAG_NOT_FOCUSABLE <span class=\"token operator\">|</span>\n                <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>FLAG_SHOW_WHEN_LOCKED<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">XiaoMiUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isMIUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token class-name\">Build</span><span class=\"token punctuation\">.</span>VERSION<span class=\"token punctuation\">.</span>SDK_INT <span class=\"token operator\">>=</span> <span class=\"token class-name\">Build</span><span class=\"token punctuation\">.</span>VERSION_CODES<span class=\"token punctuation\">.</span>N_MR1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            mLayoutParams<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>TYPE_APPLICATION<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            mLayoutParams<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token class-name\">WindowManager</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LayoutParams</span><span class=\"token punctuation\">.</span>TYPE_TOAST<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        mRect <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Rect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mStatusBarHeight <span class=\"token operator\">=</span> <span class=\"token function\">getStatusBarHeight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mListeners <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onProgressChanged</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span> seekBar<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> progress<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> fromUser<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> bubbleWidth <span class=\"token operator\">=</span> mBubble<span class=\"token punctuation\">.</span><span class=\"token function\">getWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mIsDragging <span class=\"token operator\">&amp;&amp;</span> bubbleWidth <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">float</span> x <span class=\"token operator\">=</span> mRect<span class=\"token punctuation\">.</span>left <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span> mRect<span class=\"token punctuation\">.</span><span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> seekBar<span class=\"token punctuation\">.</span><span class=\"token function\">getMax</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> progress<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>bubbleWidth <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mLayoutParams<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> x<span class=\"token punctuation\">;</span>\n            mLayoutParams<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> mRect<span class=\"token punctuation\">.</span>top <span class=\"token operator\">-</span> mStatusBarHeight <span class=\"token operator\">-</span> mBubble<span class=\"token punctuation\">.</span><span class=\"token function\">getHeight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">//更新气泡位置</span>\n            mWindowManager<span class=\"token punctuation\">.</span><span class=\"token function\">updateViewLayout</span><span class=\"token punctuation\">(</span>mBubble<span class=\"token punctuation\">,</span> mLayoutParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mBubble<span class=\"token punctuation\">.</span><span class=\"token function\">setVisibility</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">View</span><span class=\"token punctuation\">.</span>VISIBLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">OnSeekBarChangeListener</span> listener <span class=\"token operator\">:</span> mListeners<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            listener<span class=\"token punctuation\">.</span><span class=\"token function\">onProgressChanged</span><span class=\"token punctuation\">(</span>seekBar<span class=\"token punctuation\">,</span> progress<span class=\"token punctuation\">,</span> fromUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStartTrackingTouch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span> seekBar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mIsDragging <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//获取整个SeekBar在屏幕的位置</span>\n        seekBar<span class=\"token punctuation\">.</span><span class=\"token function\">getGlobalVisibleRect</span><span class=\"token punctuation\">(</span>mRect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//重复赋值left right为气泡移动范围</span>\n        <span class=\"token keyword\">int</span> offset <span class=\"token operator\">=</span> seekBar<span class=\"token punctuation\">.</span><span class=\"token function\">getThumb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getIntrinsicWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> seekBar<span class=\"token punctuation\">.</span><span class=\"token function\">getThumbOffset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mRect<span class=\"token punctuation\">.</span>left <span class=\"token operator\">=</span> mRect<span class=\"token punctuation\">.</span>left <span class=\"token operator\">+</span> seekBar<span class=\"token punctuation\">.</span><span class=\"token function\">getPaddingLeft</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">;</span>\n        mRect<span class=\"token punctuation\">.</span>right <span class=\"token operator\">=</span> mRect<span class=\"token punctuation\">.</span>right <span class=\"token operator\">-</span> seekBar<span class=\"token punctuation\">.</span><span class=\"token function\">getPaddingRight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> offset<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//将气泡加入window</span>\n        mWindowManager<span class=\"token punctuation\">.</span><span class=\"token function\">addView</span><span class=\"token punctuation\">(</span>mBubble<span class=\"token punctuation\">,</span> mLayoutParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">OnSeekBarChangeListener</span> listener <span class=\"token operator\">:</span> mListeners<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            listener<span class=\"token punctuation\">.</span><span class=\"token function\">onStartTrackingTouch</span><span class=\"token punctuation\">(</span>seekBar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStopTrackingTouch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span> seekBar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mIsDragging <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">removeBubble</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">OnSeekBarChangeListener</span> listener <span class=\"token operator\">:</span> mListeners<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            listener<span class=\"token punctuation\">.</span><span class=\"token function\">onStopTrackingTouch</span><span class=\"token punctuation\">(</span>seekBar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">View</span> <span class=\"token function\">getBubble</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> mBubble<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isDragging</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> mIsDragging<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> <span class=\"token function\">getStatusBarHeight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> height <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Resources</span> resources <span class=\"token operator\">=</span> <span class=\"token class-name\">Resources</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSystem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            height <span class=\"token operator\">=</span> resources<span class=\"token punctuation\">.</span><span class=\"token function\">getDimensionPixelSize</span><span class=\"token punctuation\">(</span>resources<span class=\"token punctuation\">.</span><span class=\"token function\">getIdentifier</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"status_bar_height\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dimen\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"android\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> height<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addOnSeekBarChangeListener</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">OnSeekBarChangeListener</span> l<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mListeners<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>l<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">removeOnSeekBarChangeListener</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">OnSeekBarChangeListener</span> l<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mListeners<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>l<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">clearOnSeekBarChangeListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mListeners<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">removeBubble</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            mWindowManager<span class=\"token punctuation\">.</span><span class=\"token function\">removeViewImmediate</span><span class=\"token punctuation\">(</span>mBubble<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//do nothing</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>onProgressChanged 下拿到 progress 进度去计算从而更新气泡位置</p>\n</blockquote>\n<p>使用方法极其简单，给<code class=\"language-text\">SeekBar</code>设置监听并交给<code class=\"language-text\">delegate</code>管理即可</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">SeekBarBubbleDelegate</span> delegate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SeekBarBubbleDelegate</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> bubbleView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nseekBar<span class=\"token punctuation\">.</span><span class=\"token function\">setOnSeekBarChangeListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SeekBar</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">OnSeekBarChangeListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onProgressChanged</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span> seekBar<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> progress<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> fromUser<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                delegate<span class=\"token punctuation\">.</span><span class=\"token function\">onProgressChanged</span><span class=\"token punctuation\">(</span>seekBar<span class=\"token punctuation\">,</span> progress<span class=\"token punctuation\">,</span> fromUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStartTrackingTouch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span> seekBar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                delegate<span class=\"token punctuation\">.</span><span class=\"token function\">onStartTrackingTouch</span><span class=\"token punctuation\">(</span>seekBar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStopTrackingTouch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SeekBar</span> seekBar<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                delegate<span class=\"token punctuation\">.</span><span class=\"token function\">onStopTrackingTouch</span><span class=\"token punctuation\">(</span>seekBar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>项目地址</h3>\n<p><a href=\"https://github.com/izyhang/SeekBarBubble\">https://github.com/izyhang/SeekBarBubble</a></p>","frontmatter":{"title":"为SeekBar添加滑动跟随气泡","date":"August 09, 2017","tags":["seekBar"],"categories":"Android"}}},"pageContext":{"slug":"/bubble-of-seekbar/","previous":{"fields":{"slug":"/java-excel-poi/"},"frontmatter":{"title":"使用POI读写Excel"}},"next":{"fields":{"slug":"/android-architecture-components/"},"frontmatter":{"title":"Android Architecture Components分析记录（一）"}}}},"staticQueryHashes":["2841359383"]}