{"componentChunkName":"component---src-templates-blog-post-js","path":"/android-do-mo-kuai-qi-dong-fang-an/","result":{"data":{"site":{"siteMetadata":{"title":"Evil Mouth","author":{"name":"Evil Mouth"}}},"markdownRemark":{"id":"4e8c56a8-790b-552c-bc98-a927f1ec22ba","excerpt":"前言 在项目模块化后，为了解决模块之间互相依赖问题，通常会引入路由框架，通过路由框架将各个模块联系到一起。模块化后各个模块还可以独立运行，这时会有这样一个问题，当模块有各自的初始化任务（比如用户信息），通常会把这些初始化任务放在 Application#onCreate…","html":"<h2>前言</h2>\n<p>在项目模块化后，为了解决模块之间互相依赖问题，通常会引入路由框架，通过路由框架将各个模块联系到一起。模块化后各个模块还可以独立运行，这时会有这样一个问题，当模块有各自的初始化任务（比如用户信息），通常会把这些初始化任务放在 Application#onCreate 方法进行初始化，当只编译一个模块时，其他模块的初始化任务有可能不需要执行，这时就只能新建一个 Application 或者抽离或者注释… 本方案就是为了解决这一现象而提出，还能解放 Application，使 Application 简洁明了</p>\n<!-- More -->\n<h2>痛点分析</h2>\n<ol>\n<li>项目启动任务数量与业务、模块的增加成正比，这也导致 Application 越加臃肿</li>\n<li>许多启动任务并不需要即时加载，通常做法也只是 post 到首页加载后</li>\n<li>模块化后，模块启动任务之间的依赖关系难以处理</li>\n</ol>\n<p>针对1，谷歌官方在 androidx 上也推行了一款<a href=\"https://developer.android.com/topic/libraries/app-startup\">启动框架</a>，通过向 provider 注册任务来解放 Application，但该框架实现相对简单，功能较少，但也对我启发不少</p>\n<p>针对2，我希望启动任务不仅仅只是延迟到首页显示后执行，而是希望启动任务能并行执行，并且由框架计算出最优执行顺序</p>\n<p>针对3，模块的启动任务由模块自行声明，通过类似路由的id指向依赖任务，并且框架在编译期间能够校验启动任务的合法性以及输出依赖关系图，辅助开发者分析启动任务链</p>\n<h2>开发</h2>\n<p>有了分析和解决路线，就开始着手开发</p>\n<h3>解决模块问题</h3>\n<p>模块问题的解决思路与路由框架一致，由于模块之间不允许互相依赖，所以有了许多路由框架的诞生。</p>\n<p>首先是声明注解</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">annotation</span> <span class=\"token keyword\">class</span> <span class=\"token function\">StartupTaskRegister</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">val</span> id<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 任务唯一id</span>\n    <span class=\"token keyword\">val</span> idDependencies<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 所依赖的任务id</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>其后就是声明注解处理器</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> StartupProcessor <span class=\"token operator\">:</span> <span class=\"token function\">AbstractProcessor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* \n    拿到使用 StartupTaskRegister 注解的 StartupTask\n    一一对应生成 STData 文件，最终 App 启动的任务类\n     */</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最后通过 Transform 插件，将这些 STData 收集并生成任务注册文件 StartupLoaderInit.class</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StartupLoaderInit</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StartupCore</span> var0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        var0<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">B__STData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        var0<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">G__STData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        var0<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">A1__STData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        var0<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">F__STData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        var0<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">E__STData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        var0<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">D__STData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        var0<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">C__STData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        var0<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">A__STData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>App 启动时，通过反射调用 StartupLoaderInit#init 方法，向框架注册启动任务，框架进行任务排序并依次启动</p>\n<h3>启动任务并行以及阻塞</h3>\n<p>启动任务需要且不仅仅只是异步执行，更需要支持阻塞启动线程。</p>\n<p>例如有启动任务A、B、C，A和B需要同时执行，C在A后，并且C需要在首页加载前执行。如果A和B只单纯放在新线程执行，那C将不能保证在首页加载前执行，此时需要阻塞启动线程，等待C完成后释放</p>\n<p>这一功能是通过使用 CountDownLatch 来实现，每个启动任务都会声明一个 CountDownLatch，个数为其依赖的数量</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token function\">CountDownLatch</span><span class=\"token punctuation\">(</span>idDependencies<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span></code></pre></div>\n<p>在执行前等待依赖完成</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// 阻塞，等待父任务完成</span>\ncountDownLatch<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">startup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>任务链排序</h3>\n<p>框架需要计算出最优的启动任务执行顺序，那就需要对启动任务进行排序，这里用到的是拓扑排序，根据每个启动任务的依赖个数进行入度计算，以此计算出启动任务排序，其中会分为两条启动任务链，同步的和异步的，最终异步的启动任务链会插在同步的启动任务链前生成最终的执行顺序</p>\n<p>详情请看 <a href=\"https://github.com/EvilMouth/Startup/blob/main/core/src/main/java/com/zyhang/startup/sort/StartupSort.kt\">core/StartuoSort.kt</a> 文件</p>\n<h3>编译期间校验</h3>\n<p>编译期需要校验启动任务之间的依赖问题，比如依赖循环，依赖缺失，有效帮助持续集成健康打包</p>\n<p>那么就需要在 Transform 阶段拿到启动任务信息集合，然后校验、排序。这里利用了 APT 阶段生成 STData 时顺带生成 STInfo ，将必要信息注入</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@STInfo</span><span class=\"token punctuation\">(</span>\n    meta <span class=\"token operator\">=</span> <span class=\"token string\">\"{\\\"async\\\":false,\\\"process\\\":\\\"\\\",\\\"id\\\":\\\"a.A\\\",\\\"idDependencies\\\":[]}\"</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Transform 插件找到 STData 的 STInfo 信息，生成集合，并执行排序校验</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">startupSimpleSort<span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span>startupInfoList<span class=\"token punctuation\">)</span></code></pre></div>\n<p>具体请看 <a href=\"https://github.com/EvilMouth/Startup/blob/main/core-plugin/src/main/java/com/zyhang/startup/plugin/sort/StartupSimpleSort.kt\">core-plugin/StartupSimpleSort.kt</a> 文件</p>\n<h3>输出依赖关系</h3>\n<p>为了辅助开发者更有效的分析启动任务链的关系，该框架通过 <a href=\"http://www.graphviz.org/about/\">graphviz</a> 工具生成可视化图</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/c58f9a6bfb2258eb9542657ae296a066/603e2/1603941343055.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe5aDQ//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAEFAl//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAACAwEAAAAAAAAAAAAAAAAAARARQSH/2gAIAQEAAT8hbM4xXpQlUf/aAAwDAQACAAMAAAAQww//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAcEAACAgMBAQAAAAAAAAAAAAABEQAhMVFxEGH/2gAIAQEAAT8QJd40YbAEfYIDbsdklXj5D5Flt+f/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"graph\"\n        title=\"graph\"\n        src=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/c58f9a6bfb2258eb9542657ae296a066/1c72d/1603941343055.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/c58f9a6bfb2258eb9542657ae296a066/a80bd/1603941343055.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/c58f9a6bfb2258eb9542657ae296a066/1c91a/1603941343055.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/c58f9a6bfb2258eb9542657ae296a066/1c72d/1603941343055.jpg 590w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/c58f9a6bfb2258eb9542657ae296a066/a8a14/1603941343055.jpg 885w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/c58f9a6bfb2258eb9542657ae296a066/603e2/1603941343055.jpg 1022w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">process-&gt;main 任务依赖关系:\n=========================================================================\n---- f.F\n|   ---- d.D\n---- a.A\n|   ---- b.B\n|   |   ---- d.D\n|   |   ---- c.C\n|   ---- d.D\n|   ---- e.E\n---- g.G\n=========================================================================</code></pre></div>\n<h3>Intellij 插件补充</h3>\n<p>由于各个模块的 StartupTask 各自以 id : String 声明，并且也是以 id 进行互相依赖，本质就是为了解决之间互相引用的问题，但是也导致了查找困难（必须通过全局搜索 id 进行跳转）</p>\n<p>为了解决这个问题，特意开发了一块 Intellij Plugin，目前也已经更新到 Github</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/52c361ce558f04851086186edecb5e01/f09ab/WX20201106-124004%402x.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 33.108108108108105%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABUklEQVQoz42R2W6DMBBF+f8vayv1JQlL4gBmKWGxwRizE93ajlr1sZaOfD3S3BnPOKyp0XABj3K4caNhOEcMQdpZ0kcL0U8QUqDtOeQgsSwLpmnCOI5QSmGeZ6ullHCKssEHUXgnEz5vI96CEXklcXZ9+NcQNMlA7iFiGsPzPbiua0mSBJRSRFEEz/PAOYc5zjIvSNiAtGRImx6Dmm2lMAxtQhxT3G53PB4ltm3Duq62w33fLcdx2Pfz+XwZDkog4S2SrwK0ZliXCW3LEQQBCCG4XFycTifkWWaTDcbYmBiM/om9DAcFUkjcc45rLsC6Gdmjg0dS+CTH5Zrg7FNcowJdJzQd6rpBWZaoqkoXby3my8bUMQNtWAemF1PVLVgrwTW9HNH1Si9k1AvRWigdk3YcwzD8Iv/EhBBwjmPXgd62f9i5bJZtW7Hriru+f/T2D74BXkgRDRkjxNkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"WX20201106 124004 2x\" title=\"WX20201106 124004 2x\" src=\"/static/52c361ce558f04851086186edecb5e01/fcda8/WX20201106-124004%402x.png\" srcset=\"/static/52c361ce558f04851086186edecb5e01/12f09/WX20201106-124004%402x.png 148w,\n/static/52c361ce558f04851086186edecb5e01/e4a3f/WX20201106-124004%402x.png 295w,\n/static/52c361ce558f04851086186edecb5e01/fcda8/WX20201106-124004%402x.png 590w,\n/static/52c361ce558f04851086186edecb5e01/efc66/WX20201106-124004%402x.png 885w,\n/static/52c361ce558f04851086186edecb5e01/c83ae/WX20201106-124004%402x.png 1180w,\n/static/52c361ce558f04851086186edecb5e01/f09ab/WX20201106-124004%402x.png 1250w\" sizes=\"(max-width: 590px) 100vw, 590px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span></img></p>\n<blockquote>\n<p>该插件在<strong>2020.1</strong>版本上开发，所以需要 <strong>AS</strong> 更新到 <strong>201.6668.121</strong> 以上</p>\n</blockquote>\n<h2>总结</h2>\n<p>至此框架完成，并已开源 <a href=\"https://github.com/EvilMouth/Startup\">EvilMouth/Startup</a></p>","frontmatter":{"title":"Android 多模块启动方案","date":"October 28, 2020","tags":["modular","startup"],"categories":"Android"}}},"pageContext":{"slug":"/android-do-mo-kuai-qi-dong-fang-an/","previous":{"fields":{"slug":"/cong-hexo-dao-gatsby/"},"frontmatter":{"title":"从 Hexo 到 Gatsby"}},"next":{"fields":{"slug":"/zi-dk-yi-glide-target-ui-xm-ds-td-textview-imagespan/"},"frontmatter":{"title":"自定义 Glide Target 实现动态 TextView ImageSpan"}}}},"staticQueryHashes":["2841359383"]}