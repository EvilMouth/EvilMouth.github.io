{"componentChunkName":"component---src-templates-blog-post-js","path":"/android-architecture-components-2/","result":{"data":{"site":{"siteMetadata":{"title":"Evil Mouth's Blog"}},"markdownRemark":{"id":"d7aa2cc7-e8b3-532e-a469-686516cc2c89","excerpt":"è®°å½•åˆ†æç¬¬äºŒç¯‡---ï¼Œå®˜æ–¹åœ°å€\nhttps://developer.android.com/topic/libraries/architecture/livedata.html?hl=zh-cn LiveDataâ€¦","html":"<p>è®°å½•åˆ†æ<code class=\"language-text\">AAC</code>ç¬¬äºŒç¯‡---<code class=\"language-text\">LiveData</code>ï¼Œå®˜æ–¹åœ°å€\n<a href=\"https://developer.android.com/topic/libraries/architecture/livedata.html?hl=zh-cn\">https://developer.android.com/topic/libraries/architecture/livedata.html?hl=zh-cn</a></p>\n<!-- More -->\n<h1>LiveData</h1>\n<p><code class=\"language-text\">LiveData</code>æ˜¯ä¸€ä¸ªæ•°æ®æŒæœ‰ç±»å¹¶èµ‹äºˆæ•°æ®<code class=\"language-text\">Observer</code>å±æ€§ï¼Œä½¿ç”¨<code class=\"language-text\">LiveData</code>èƒ½å¤Ÿåœ¨æœ‰è§‚å¯Ÿè€…çš„æ—¶å€™è§¦å‘è·å–è¯·æ±‚ï¼Œå¹¶åœ¨ç”Ÿå‘½å‘¨æœŸç¬¦åˆ<code class=\"language-text\">OnStart</code>çŠ¶æ€æ¡ä»¶ä¸‹é€šçŸ¥è§‚å¯Ÿè€…æ•°æ®å˜åŒ–ï¼Œæ‰€ä»¥å®˜æ–¹å¾ˆåŠçš„è¯´æ˜ä¸‹é¢å‡ ç‚¹</p>\n<ul>\n<li>No memory leaks</li>\n<li>No crashes due to stopped activities</li>\n<li>Always up to date data</li>\n<li>Proper configuration change</li>\n<li>Sharing Resources</li>\n<li>No more manual lifecycle handling</li>\n</ul>\n<h2>ä½¿ç”¨</h2>\n<p>æ¯”å¦‚æœ€å¸¸ç”¨çš„<code class=\"language-text\">UserInfo</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserInfoLiveData</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">LiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//å½“æœ‰è§‚å¯Ÿè€…è§‚å¯Ÿæ—¶ä¼šè§¦å‘onActive</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//å‡è®¾è·å–UserInfoå¹¶è¿”å›</span>\n        <span class=\"token class-name\">UserInfo</span> userInfo <span class=\"token operator\">=</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>åœ¨<code class=\"language-text\">Activity</code>æ·»åŠ è§‚å¯Ÿä»£ç </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Bundle</span> savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">UserInfoLiveData</span> userInfoLiveData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserInfoLiveData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    userInfoLiveData<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">UserInfo</span> userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//æ­¤æ–¹æ³•ä¼šåœ¨LiveDataçš„setValueè¢«è°ƒç”¨</span>\n            <span class=\"token comment\">//åœ¨è¿™é‡Œæ›´æ–°UI</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>åˆ†æ</h2>\n<p>è¿›å…¥æ­£é¢˜ï¼Œè¿™æ¬¡ä»<code class=\"language-text\">LiveData</code>çš„<code class=\"language-text\">observe</code>æ–¹æ³•å¼€å§‹è¿½å¯»ï¼Œçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ</p>\n<h3>observe(LifecycleOwner, Observer<T>)</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">SafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Observer</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">></span></span> mObservers <span class=\"token operator\">=</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">SafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token annotation punctuation\">@MainThread</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> DESTROYED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// ignore</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token class-name\">LifecycleBoundObserver</span> wrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">LifecycleBoundObserver</span> existing <span class=\"token operator\">=</span> mObservers<span class=\"token punctuation\">.</span><span class=\"token function\">putIfAbsent</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> existing<span class=\"token punctuation\">.</span>owner <span class=\"token operator\">!=</span> wrapper<span class=\"token punctuation\">.</span>owner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot add the same observer\"</span>\n                    <span class=\"token operator\">+</span> <span class=\"token string\">\" with different lifecycles\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token function\">isActiveState</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>è¿™ä¸ª<code class=\"language-text\">observe</code>æ–¹æ³•æºç ä¸Šé¢ä¸€å †å¯†å¯†éº»éº»çš„æ³¨é‡Šï¼Œå¤§æ¦‚é‡ç‚¹å°±æ˜¯å½“æ•°æ®æœ‰å˜åŒ–çš„æ—¶å€™å°±ä¼šé€šçŸ¥è§‚å¯Ÿè€…ã€‚\né¦–å…ˆä¸ç”¨å¤šè¯´ï¼Œç¡®å®šä¸‹å½“å‰ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€ï¼Œä¸æ»¡è¶³æ¡ä»¶å°±<code class=\"language-text\">return</code>ï¼Œä¹‹åå°†ä¼ è¿›æ¥çš„<code class=\"language-text\">owner</code>å’Œ<code class=\"language-text\">observer``new</code>äº†ä¸ª<code class=\"language-text\">LifecycleBoundObserver</code>ï¼Œå…ˆä¸ç®¡ã€‚ç„¶åé€šè¿‡<code class=\"language-text\">mObservers</code>ä»<code class=\"language-text\">Map</code>ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ç›¸åŒçš„<code class=\"language-text\">LifecycleBoundObserver</code>ï¼Œæ ¹æ®<code class=\"language-text\">Observer</code>ä¸º<code class=\"language-text\">key</code>å»æŸ¥æ‰¾ï¼Œå¦‚æœå­˜åœ¨ä¹Ÿ<code class=\"language-text\">retuen</code>ã€‚è¿™é‡Œæ³¨æ„å®˜æ–¹ä¸å…è®¸åŒä¸ª<code class=\"language-text\">Observer</code>æ·»åŠ åˆ°ä¸åŒçš„<code class=\"language-text\">owner</code>ã€‚æ¥ç€è°ƒç”¨<code class=\"language-text\">owner.getLifecycle().addObserver(wrapper);</code>ã€‚ã€‚ã€‚çœ‹æ¥è¿™ä¸ª<code class=\"language-text\">LifecycleBoundObserver</code>ä¹Ÿæ˜¯å®ç°äº†<code class=\"language-text\">LifecycleObserver</code>(è‡³äºè¿™ä¸ªç‚¹å¯ä»¥çœ‹ç¬¬ä¸€ç¯‡)ã€‚æœ€åè°ƒç”¨<code class=\"language-text\">LifecycleBoundObserver</code>çš„<code class=\"language-text\">activeStateChanged</code>æ–¹æ³•ï¼Œå…·ä½“å®ç°åˆšå¥½è·Ÿåˆšæ‰ä¸ç®¡çš„ä¸€èµ·åˆ†æ</p>\n<h3>LifecycleBoundObserver</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">LifecycleBoundObserver</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">LifecycleObserver</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> active<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> lastVersion <span class=\"token operator\">=</span> START_VERSION<span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>owner <span class=\"token operator\">=</span> owner<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>observer <span class=\"token operator\">=</span> observer<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unused\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token annotation punctuation\">@OnLifecycleEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Lifecycle</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">.</span>ON_ANY<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">void</span> <span class=\"token function\">onStateChange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> DESTROYED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token comment\">// immediately set active state, so we'd never dispatch anything to inactive</span>\n            <span class=\"token comment\">// owner</span>\n            <span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token function\">isActiveState</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">void</span> <span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> newActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newActive <span class=\"token operator\">==</span> active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            active <span class=\"token operator\">=</span> newActive<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">boolean</span> wasInactive <span class=\"token operator\">=</span> <span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">+=</span> active <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wasInactive <span class=\"token operator\">&amp;&amp;</span> active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">onActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">onInactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>åˆšæ‰åœ¨<code class=\"language-text\">observe</code>æ–¹æ³•å†…å®ä¾‹åŒ–æ—¶ä¼ è¿›æ¥çš„<code class=\"language-text\">owner</code>å’Œ<code class=\"language-text\">observer</code>åªæ˜¯èµ‹å€¼äº†ä¸€ä¸‹å†…éƒ¨å˜é‡ã€‚å…¶æ¬¡<code class=\"language-text\">owner.getLifecycle().addObserver(wrapper);</code>æ„å‘³ç€<code class=\"language-text\">onStateChange()</code>èƒ½å¤Ÿæ¥æ”¶ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–é€šçŸ¥ï¼Œæœä¸å…¶ç„¶<code class=\"language-text\">onStateChange</code>ä¸­è°ƒç”¨äº†\n<code class=\"language-text\">activeStateChanged(isActiveState(owner.getLifecycle().getCurrentState()));</code>ã€‚</p>\n<blockquote>\n<p>isActiveState() è¿”å› boolean -> å½“å‰ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æ˜¯å¦è‡³å°‘å¤„äºSTARTçŠ¶æ€ä¹‹å</p>\n</blockquote>\n<p><code class=\"language-text\">activeStateChanged</code>æ–¹æ³•ä¼šæ ¹æ®ä¼ è¿›æ¥çš„<code class=\"language-text\">newActive</code>çŠ¶æ€å»è°ƒç”¨<code class=\"language-text\">onActive()</code>æˆ–è€…<code class=\"language-text\">onInactive()</code>ï¼Œä¹Ÿå°±æ˜¯å½“æœ‰è§‚å¯Ÿè€…ä¸»åŠ¨è§‚å¯Ÿæ—¶ä¼šè°ƒç”¨<code class=\"language-text\">onActive()</code>è¿›è¡Œæ•°æ®è·å–è¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚æ•°æ®æˆåŠŸåæ‰‹åŠ¨è°ƒç”¨<code class=\"language-text\">setValue(T)</code>é€šçŸ¥è§‚å¯Ÿè€…æ•°æ®å˜åŒ–ã€‚<code class=\"language-text\">setValue(T)</code>å†…è°ƒç”¨<code class=\"language-text\">dispatchingValue()</code>æ–¹æ³•æœ€åå›è°ƒ<code class=\"language-text\">onChanged(T)</code>é€šçŸ¥è§‚å¯Ÿè€…æ•°æ®å˜åŒ–ä»è€Œæ›´æ–°UIã€‚</p>\n<p>ä¸€å¥å¥ç†è§£</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//å½“æœ‰è§‚å¯Ÿè€…è§‚å¯Ÿçš„æ—¶å€™æˆ–è€…ç”Ÿå‘½å‘¨æœŸå˜åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨æ­¤æ–¹æ³•</span>\n<span class=\"token comment\">//newActive : å½“å‰ç”Ÿå‘½å‘¨æœŸæ˜¯å¦STARTçŠ¶æ€ä¹‹å</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> newActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//å¦‚æœæ–°çŠ¶æ€ä¸å½“å‰çŠ¶æ€ä¸€è‡´åˆ™return</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newActive <span class=\"token operator\">==</span> active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//æ ‡æ˜å½“å‰æ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€</span>\n    active <span class=\"token operator\">=</span> newActive<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//mActiveCountæ˜¯æœ‰å¤šå°‘ä¸ªè§‚å¯Ÿè€…åœ¨è§‚å¯Ÿ</span>\n    <span class=\"token comment\">//æ‰€ä»¥wasInactiveè¡¨ç¤ºåœ¨è¿™ä¹‹å‰çš„è§‚å¯Ÿè€…æ•°</span>\n    <span class=\"token keyword\">boolean</span> wasInactive <span class=\"token operator\">=</span> <span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//ç›¸åº”çš„+-1</span>\n    <span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">+=</span> active <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè§‚å¯Ÿå¹¶ä¸”æ¿€æ´»çŠ¶æ€åˆ™å›è°ƒonActive()å»è·å–æ•°æ®</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wasInactive <span class=\"token operator\">&amp;&amp;</span> active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">onActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//å¯¹åº”çš„å–æ¶ˆç»‘å®š</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mActiveCount <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">onInactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//ä¸‹å‘æ•°æ®å˜åŒ– ä¼šå›è°ƒonChanged(T)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>dispatchingValue(LifecycleBoundObserver)</h3>\n<p>ä¸‹é¢çœ‹<code class=\"language-text\">dispatchingValue()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">LifecycleBoundObserver</span> initiator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDispatchingValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            mDispatchInvalidated <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        mDispatchingValue <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n            mDispatchInvalidated <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initiator <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span>initiator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                initiator <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Observer</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span>\n                        mObservers<span class=\"token punctuation\">.</span><span class=\"token function\">iteratorWithAdditions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span>iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDispatchInvalidated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>mDispatchInvalidated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mDispatchingValue <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘åˆ¤æ–­ä¸»è¦ä¾èµ–äºä¸¤ä¸ª<code class=\"language-text\">boolean</code>:<code class=\"language-text\">mDispatchingValue</code>å’Œ<code class=\"language-text\">mDispatchInvalidated</code>ã€‚çœ‹å®Œæºç åæ„Ÿè§‰å¾ˆå·§å¦™ï¼Œåˆ©ç”¨ä¸¤ä¸ªå˜é‡åˆ†å‘æ•°æ®çš„å˜åŒ–é€šçŸ¥è§‚å¯Ÿè€…æ›´æ–°UIï¼Œå¹¶å½“æœ‰æ–°çš„æ•°æ®å˜åŒ–çš„æ—¶å€™<code class=\"language-text\">break</code>å¾ªç¯ï¼Œå‡å°‘äº†ä¸€æ¬¡æ—§æ•°æ®ä¸å¿…è¦çš„UIæ›´æ–°ï¼Œå¾ˆ<code class=\"language-text\">nice</code>ï¼Œç‚¹ä¸ªèµã€‚</p>\n<h3>mVersion</h3>\n<p><code class=\"language-text\">LiveData</code>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå˜é‡<code class=\"language-text\">mVersion</code>æ•°æ®ç‰ˆæœ¬æ§åˆ¶ï¼Œè®¡ç®—æ•°æ®å˜åŒ–æ¬¡æ•°ï¼Œå¹¶åœ¨<code class=\"language-text\">dispatchingValue()</code>ä¸‹å‘ä¸­ä¸è§‚å¯Ÿè€…çš„å†…éƒ¨è®¡æ•°<code class=\"language-text\">version</code>åˆ¤æ–­ä»è€Œè°ƒç”¨<code class=\"language-text\">onChanged(T)</code>ã€‚</p>\n<h2>é¢å¤–ç”¨æ³•</h2>\n<p><code class=\"language-text\">LiveData</code>è¿˜æœ‰ä¸¤ä¸ªå¾ˆæœ‰ç”¨çš„<code class=\"language-text\">API</code></p>\n<ul>\n<li>\n<p>observeForever(Observer<T> observer)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@MainThread</span>\n <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">observeForever</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>ALWAYS_ON<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">ALWAYS_ON</code>ä¹Ÿæ˜¯ä¸€ä¸ª<code class=\"language-text\">LifecycleOwner</code>ï¼Œä½†æ˜¯æ°¸è¿œå¤„äº<code class=\"language-text\">RESUME</code>çŠ¶æ€ä¸‹ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨è¿™ä¸ªæ–¹æ³•çš„è§‚å¯Ÿè€…å°†æ°¸è¿œæ¥æ”¶åˆ°æ•°æ®å˜åŒ–ï¼Œæ— è®ºç”Ÿå‘½å‘¨æœŸçš„å½±å“ï¼Œæ‰€ä»¥åœ¨é€‚å½“çš„æ—¶å€™éœ€è¦å¼€å‘è€…æ‰‹åŠ¨è°ƒç”¨<code class=\"language-text\">removeObserver(Observer)</code>å–æ¶ˆè§‚å¯Ÿã€‚</p>\n</li>\n<li>\n<p>postValue(T value)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">postValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     <span class=\"token keyword\">boolean</span> postTask<span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>mDataLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         postTask <span class=\"token operator\">=</span> mPendingData <span class=\"token operator\">==</span> NOT_SET<span class=\"token punctuation\">;</span>\n         mPendingData <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>postTask<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n     <span class=\"token class-name\">AppToolkitTaskExecutor</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">postToMainThread</span><span class=\"token punctuation\">(</span>mPostValueRunnable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span></code></pre></div>\n<p>ä¸<code class=\"language-text\">setValue(T)</code>ä¸åŒçš„<code class=\"language-text\">postValue(T)</code>å…è®¸åœ¨å…¶å®ƒçº¿ç¨‹è°ƒç”¨</p>\n</li>\n</ul>\n<h1>Transformations of LiveData</h1>\n<p>å®˜æ–¹æä¾›<code class=\"language-text\">Transformations</code>å·¥å…·å¸®åŠ©æ–¹ä¾¿çš„è½¬æ¢<code class=\"language-text\">LiveData</code>å¹¶ä¸”ä¾æ—§æ‹¥æœ‰<code class=\"language-text\">è¢«è½¬æ¢è€…</code>çš„æ•°æ®å˜åŒ–é€šçŸ¥ã€‚ä¸‹é¢ç»™ä¸ªğŸŒ°</p>\n<blockquote>\n<p>map(LiveData<X> source, final Function&#x3C;X, Y> func)\nswitchMap(LiveData<X> trigger, final Function&#x3C;X, LiveData<Y>> func)</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">LiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> stringLiveData <span class=\"token operator\">=</span> <span class=\"token class-name\">Transformations</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>userInfoLiveData<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserInfo</span> input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        stringLiveData<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">String</span> s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">i</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"onChanged: s === \"</span> <span class=\"token operator\">+</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">stringLiveData</code>é€šè¿‡<code class=\"language-text\">Transformations.map()</code>æ–¹æ³•å®ä¾‹åŒ–ï¼Œåœ¨<code class=\"language-text\">apply(UserInfo input)</code>ä¸­å–å‡ºéœ€è¦çš„<code class=\"language-text\">String</code>æ•°æ®è¿”å›ï¼Œæœ€ååŒæ ·çš„<code class=\"language-text\">observe</code>ä¸€ä¸‹ï¼Œå°†ä¼šæ‹¥æœ‰çš„åŠŸèƒ½å³ï¼šå½“<code class=\"language-text\">userInfo</code>æ•°æ®æ”¹å˜ï¼ŒåŒæ ·ä¼šé€šçŸ¥æ­¤<code class=\"language-text\">LiveData</code>çš„è§‚å¯Ÿè€…å³å›è°ƒ<code class=\"language-text\">onChanged(T)</code>ã€‚</p>\n<h2>åˆ†æ</h2>\n<p>å®˜æ–¹æä¾›è¿™ä¸ªè½¬æ¢<code class=\"language-text\">API</code>çš„åŸå› æ˜¯å¼€å‘è€…å¯èƒ½éœ€è¦åœ¨æ•°æ®å˜åŒ–å‘é€ç»™è§‚å¯Ÿè€…ä¹‹å‰å¯¹æ•°æ®è¿›è¡Œæ”¹å˜ç­‰æ“ä½œï¼Œè¿™æ ·çš„ç¡®ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚é‚£ä¹ˆå¼€å§‹çœ‹æºç å§~</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@MainThread</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">X</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">LiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">X</span><span class=\"token punctuation\">></span></span> source<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">X</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span></span> func<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">MediatorLiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Y</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MediatorLiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        result<span class=\"token punctuation\">.</span><span class=\"token function\">addSource</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">X</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">X</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                result<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>å…ˆçœ‹<code class=\"language-text\">map()</code>ï¼Œè¿™é‡Œé¢æ¶‰åŠåˆ°ä¸‰ä¸ª<code class=\"language-text\">Observer</code>ï¼Œå¯èƒ½ä¼šæœ‰ç‚¹ç»•ã€‚é¦–å…ˆä¸€è¿›æ¥å°±å®ä¾‹äº†ä¸€ä¸ª<code class=\"language-text\">MediatorLiveData&lt;Y&gt;</code>ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª<code class=\"language-text\">LiveData</code>ï¼Œ<code class=\"language-text\">map()</code>è¿”å›çš„å°±æ˜¯è¿™ä¸ªå®¶ä¼™ã€‚è¿”å›ä¹‹å‰è°ƒç”¨äº†<code class=\"language-text\">addSource()</code>ä¼ å…¥äº†ç¬¬ä¸€ä¸ª<code class=\"language-text\">Observer</code>ã€‚<code class=\"language-text\">map()</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°<code class=\"language-text\">Function</code>å°±æ˜¯åœ¨è¿™é‡Œè¢«å›è°ƒã€‚æ¥ç€çœ‹<code class=\"language-text\">addSource()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">SafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LiveData</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Source</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> mSources <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token annotation punctuation\">@MainThread</span>\n    <span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">void</span> <span class=\"token function\">addSource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">></span></span> source<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">></span></span> onChanged<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Source</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">></span></span> e <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Source</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> onChanged<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Source</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> existing <span class=\"token operator\">=</span> mSources<span class=\"token punctuation\">.</span><span class=\"token function\">putIfAbsent</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> existing<span class=\"token punctuation\">.</span>mObserver <span class=\"token operator\">!=</span> onChanged<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token string\">\"This source was already added with the different observer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hasActiveObservers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">plug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>çœ‹èµ·æ¥ä¼¼æ›¾ç›¸è¯†ï¼Œ<code class=\"language-text\">LiveData.observe()</code>çš„é€»è¾‘è·Ÿè¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å·®ä¸å¤šä¸€ä¸ªæ ·ï¼ŒåŸç†éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™é‡Œå®ä¾‹åŒ–äº†ä¸€ä¸ª<code class=\"language-text\">Source</code>ï¼Œä¸»è¦æ˜¯ä¸ºäº†ä¿å­˜ä¸€ä¸‹æ•°æ®å˜åŒ–çš„<code class=\"language-text\">version</code>ï¼Œå¥½åˆ¤æ–­é€šçŸ¥è§‚å¯Ÿè€…çš„æ—¶æœºã€‚\nè¿™é‡Œæœ‰ä¸ª<code class=\"language-text\">hasActiveObservers()</code>çš„åˆ¤æ–­ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰è§‚å¯Ÿè€…è§‚å¯Ÿï¼Œæœ‰çš„è¯æ‰§è¡Œ<code class=\"language-text\">plug()</code>ï¼Œé‚£ä¹ˆçœ‹å‘<code class=\"language-text\">Source</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Source</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">LiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> mLiveData<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> mObserver<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> mVersion <span class=\"token operator\">=</span> START_VERSION<span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Source</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> liveData<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            mLiveData <span class=\"token operator\">=</span> liveData<span class=\"token punctuation\">;</span>\n            mObserver <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token annotation punctuation\">@Override</span>\n                <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">V</span> v<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mVersion <span class=\"token operator\">!=</span> mLiveData<span class=\"token punctuation\">.</span><span class=\"token function\">getVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        mVersion <span class=\"token operator\">=</span> mLiveData<span class=\"token punctuation\">.</span><span class=\"token function\">getVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        observer<span class=\"token punctuation\">.</span><span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">void</span> <span class=\"token function\">plug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            mLiveData<span class=\"token punctuation\">.</span><span class=\"token function\">observeForever</span><span class=\"token punctuation\">(</span>mObserver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">void</span> <span class=\"token function\">unplug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            mLiveData<span class=\"token punctuation\">.</span><span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span>mObserver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">plug()</code>å’Œ<code class=\"language-text\">unplug()</code>ä¸å¿…å¤šè¯´ï¼Œæ ‡å‡†çš„æ³¨å†Œå–æ¶ˆæ³¨å†Œæ­¥éª¤ã€‚çœ‹çœ‹æ„é€ å‡½æ•°é‡Œé¢åˆ\bæ¥äº†ä¸ª<code class=\"language-text\">Observer</code>ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ª<code class=\"language-text\">Observer</code>ï¼Œåœ¨å›è°ƒå‡½æ•°<code class=\"language-text\">onChanged</code>é‡Œåˆ¤æ–­äº†ä¸‹<code class=\"language-text\">version</code>ï¼Œå‰åä¸ä¸€è‡´çš„è¯æ‰‹åŠ¨è°ƒç”¨<code class=\"language-text\">observer.onChanged(v);</code>ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ª<code class=\"language-text\">observer</code>ã€‚æœ‰ç‚¹ç»•äº†0 0</p>\n<p>é‚£ä¹ˆç¬¬ä¸‰ä¸ª<code class=\"language-text\">Observer</code>åœ¨å“ªé‡Œå‘¢ï¼Œå…¶å®å°±æ˜¯ä¸€å¼€å§‹é€šè¿‡<code class=\"language-text\">map()</code>è½¬æ¢å¾—æ¥çš„<code class=\"language-text\">LiveData</code>:<code class=\"language-text\">stringLiveData</code>è¿›è¡Œè§‚å¯Ÿçš„<code class=\"language-text\">observer</code>ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹\n1.é€šè¿‡<code class=\"language-text\">map()</code>è½¬æ¢æ‹¿åˆ°<code class=\"language-text\">MediatorLiveData</code>\n2.è°ƒç”¨<code class=\"language-text\">observe()</code>å¯¹è½¬æ¢æ¥çš„<code class=\"language-text\">MediatorLiveData</code>è¿›è¡Œè§‚å¯Ÿ\n3.ç”Ÿå‘½å‘¨æœŸåˆ°è¾¾<code class=\"language-text\">START</code>åä¼šè‡ªåŠ¨è°ƒç”¨<code class=\"language-text\">onActive()</code>\n4.<code class=\"language-text\">MediatorLiveData.onActive()</code>ä¼šéå†è°ƒç”¨<code class=\"language-text\">plug()</code>\n5.<code class=\"language-text\">plug()</code>ä¸­å¯¹<code class=\"language-text\">æºLiveData</code>è°ƒç”¨<code class=\"language-text\">observe()</code>è§‚å¯Ÿ\n6.<code class=\"language-text\">æºLiveData</code>å›è°ƒ<code class=\"language-text\">onChanged()</code>å³<code class=\"language-text\">Source</code>ä¸­çš„<code class=\"language-text\">observer</code>(ç¬¬äºŒä¸ª<code class=\"language-text\">observer</code>)\n7.ç»§ç»­å›è°ƒç¬¬ä¸€ä¸ª<code class=\"language-text\">onChanged()</code>ä¹Ÿå°±æ˜¯<code class=\"language-text\">Transformations.map()</code>ä¸­çš„<code class=\"language-text\">Observer</code>\n8.<code class=\"language-text\">result.setValue(func.apply(x));</code>\n9.æœ€ç»ˆå›è°ƒç¬¬ä¸‰ä¸ª<code class=\"language-text\">onChanged()</code>ï¼šå¼€å‘è€…è‡ªå·±çš„<code class=\"language-text\">observer</code>ä»è€Œæ›´æ–°UI</p>\n<p>æœ‰ç‚¹ç´¯ï¼Œé¥¶äº†åŠå¤©ï¼Œä¸è¿‡ç»ˆäºçŸ¥é“ä¸ºä½•æºæ•°æ®å‘ç”Ÿæ•°æ®å˜åŒ–æ—¶ï¼Œ<code class=\"language-text\">æ–°LiveData</code>ä¹Ÿèƒ½åŠæ—¶å“åº”çš„åŸå› ã€‚</p>\n<p>è‡³äº<code class=\"language-text\">switchMap()</code>æ›´ç²—æš´æ›´è‡ªç”±åŒ–ï¼Œå†…éƒ¨è¿˜ä¼šè‡ªåŠ¨åˆ¤æ–­å‰å<code class=\"language-text\">LiveData</code>çš„ä¸åŒè‡ªåŠ¨å–æ¶ˆè§‚å¯Ÿç­‰ç­‰ï¼Œæ‰€ä»¥å¼€å‘è€…ä¸éœ€è¦æ‹…å¿ƒå†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚</p>\n<h1>æ€»ç»“</h1>\n<p><code class=\"language-text\">LiveData</code>çš„ç”¨æ³•è¿˜æ˜¯æŒºæ–¹ä¾¿çš„ï¼Œå†…éƒ¨å¸®åŠ©æŒæœ‰éœ€è¦çš„æ•°æ®ï¼Œå¹¶ä½¿ç”¨<code class=\"language-text\">è§‚å¯Ÿè€…æ¨¡å¼</code>å¯¹æ•°æ®å˜åŒ–è¿›è¡Œè§‚å¯Ÿï¼Œå¹¶æ‹¥æœ‰ç”Ÿå‘½å‘¨æœŸçš„ç‰¹æ•ˆï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå†…å­˜æ³„éœ²ç­‰é—®é¢˜ã€‚\nå¯¹äºåƒå®˜æ–¹æä¾›çš„ä¾‹å­ä¸­çš„<code class=\"language-text\">Location</code>æˆ–è€…å¼€å‘é¡¹ç›®ä¸­æœ€å¸¸è§çš„<code class=\"language-text\">UserInfo</code>ï¼Œç”šè‡³å¯ä»¥ç”¨<code class=\"language-text\">static</code>ä¿®é¥°<code class=\"language-text\">LiveData</code>ä½¿å…¶å¯ä»¥ä¾›åº”ç»™æ‰€æœ‰éœ€è¦çš„åœ°æ–¹ã€‚</p>","frontmatter":{"title":"Android Architecture Componentsåˆ†æè®°å½•ï¼ˆäºŒï¼‰","date":"August 16, 2017","tags":["aac"],"categories":"Android"}}},"pageContext":{"slug":"/android-architecture-components-2/","previous":{"fields":{"slug":"/android-architecture-components/"},"frontmatter":{"title":"Android Architecture Componentsåˆ†æè®°å½•ï¼ˆä¸€ï¼‰"}},"next":{"fields":{"slug":"/android-architecture-components-3/"},"frontmatter":{"title":"Android Architecture Componentsåˆ†æè®°å½•ï¼ˆä¸‰ï¼‰"}}}},"staticQueryHashes":["2841359383"]}