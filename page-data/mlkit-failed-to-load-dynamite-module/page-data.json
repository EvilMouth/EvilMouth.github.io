{"componentChunkName":"component---src-templates-blog-post-js","path":"/mlkit-failed-to-load-dynamite-module/","result":{"data":{"site":{"siteMetadata":{"title":"Evil Mouth","author":{"name":"Evil Mouth"}}},"markdownRemark":{"id":"ef073929-9d46-5f20-bab4-efeb55c46173","excerpt":"记一次 mlkit…","html":"<p>记一次 <em>mlkit</em> 错误分析</p>\n<!-- more -->\n<h2>前景</h2>\n<p>项目接入<code class=\"language-text\">mlkit</code>-<code class=\"language-text\">barcode</code>功能，考虑到国产大部分手机不支持<code class=\"language-text\">google play services</code>，遂使用模型捆绑包的依赖方式接入<code class=\"language-text\">sdk</code></p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">implementation <span class=\"token string\">'com.google.mlkit:barcode-scanning:17.1.0'</span></code></pre></div>\n<p>该引入方式会将<code class=\"language-text\">barcode</code>的识别模型一起打包到<code class=\"language-text\">apk</code>里，虽然包体积会大一些，但起码所有手机都能用</p>\n<blockquote>\n<p>另一种<a href=\"https://developers.google.com/ml-kit/vision/barcode-scanning/android\">引入方式</a>需要依赖<code class=\"language-text\">google play services</code>，会动态下载识别模型</p>\n</blockquote>\n<h2>问题</h2>\n<p>在<code class=\"language-text\">demo</code>工程试接了下，国产手机运行正常，遂接入到项目工程，但运行报错</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Invalid GmsCore APK, remote loading disabled.\n\nError preloading model resource\ncom.google.mlkit.common.MlKitException: Failed to load deprecated vision dynamite module.\n\nCaused by: com.google.android.gms.dynamite.DynamiteModule$LoadingException: No acceptable module com.google.android.gms.vision.dynamite found. Local version is 0 and remote version is 0.</code></pre></div>\n<p>下载模型失败？我不是用的捆绑包吗？怎么还去下载模型？</p>\n<h2>分析</h2>\n<p>再重新看日志，发现没找到模型的版本都是<em>0</em></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Local version is 0 and remote version is 0.</code></pre></div>\n<p>在之前还有一句日志</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">DynamiteModule           W  Local module descriptor class for com.google.mlkit.dynamite.barcode not found.</code></pre></div>\n<p>找不到本地的模型，进<code class=\"language-text\">DynamiteModule</code>看看是怎么找的</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">context <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">ClassLoader</span> context1 <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nvar2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nvar2<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com.google.android.gms.dynamite.descriptors.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nvar2<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>moduleId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nvar2<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".ModuleDescriptor\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Class</span> context2 <span class=\"token operator\">=</span> context1<span class=\"token punctuation\">.</span><span class=\"token function\">loadClass</span><span class=\"token punctuation\">(</span>var2<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nvar15 <span class=\"token operator\">=</span> context2<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MODULE_ID\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncontext3 <span class=\"token operator\">=</span> context2<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MODULE_VERSION\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nvar3 <span class=\"token operator\">=</span> <span class=\"token class-name\">Objects</span><span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>var15<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> moduleId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>发现<code class=\"language-text\">DynamiteModule</code>会用反射去取<code class=\"language-text\">ModuleDescriptor</code>下的<code class=\"language-text\">MODULE_ID</code>和<code class=\"language-text\">MODULE_VERSION</code>两个常量值来获取模型版本</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@DynamiteApi</span>\n<span class=\"token annotation punctuation\">@RetainForClient</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ModuleDescriptor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@RetainForClient</span>\n    <span class=\"token annotation punctuation\">@NonNull</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">MODULE_ID</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"com.google.android.gms.measurement.dynamite\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@RetainForClient</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">MODULE_VERSION</span> <span class=\"token operator\">=</span> <span class=\"token number\">70</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ModuleDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>找不到说明反射失败了，说明这个类没打包进<code class=\"language-text\">apk</code>或其它问题，反编译下<code class=\"language-text\">apk</code>发现两个常量没了，难怪找不到</p>\n<h2>原因</h2>\n<p>这么一想，项目接了个常量内联的插件，插件没检测出来误伤把这两个常量干掉了，导致加载本地模型失败</p>","frontmatter":{"title":"MlKitException Failed to load deprecated vision dynamite module","date":"April 17, 2023","tags":["mlkit","barcode","google play services"],"categories":"Android"}}},"pageContext":{"id":"ef073929-9d46-5f20-bab4-efeb55c46173","previousPostId":"3add9c97-6c5c-5390-baf4-586fe21510c6","nextPostId":null}},"staticQueryHashes":["2841359383"],"slicesMap":{}}