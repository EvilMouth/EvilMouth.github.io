{"componentChunkName":"component---src-templates-blog-post-js","path":"/android-webview-js-yu-lan-tu-pian-zhi-wei-xin-wen-zhang/","result":{"data":{"site":{"siteMetadata":{"title":"Evil Mouth","author":{"name":"Evil Mouth"}}},"markdownRemark":{"id":"a136d41b-24d8-515f-8b6a-971d8c971f9c","excerpt":"通常的做法是通过，然后遍历元素拿到为图片地址。但是针对微信公众号文章就不适用了，尤其是其图片元素采用懒加载方式，所以取到的为空，但是在微信客户端能够正常取到所有图片，所以对文章进行分析 0x0…","html":"<p>通常的做法是通过<code class=\"language-text\">document.getElementsByTagName(&quot;img&quot;)</code>，然后遍历元素拿到<code class=\"language-text\">src</code>为图片地址。但是针对微信公众号文章就不适用了，尤其是其图片元素采用懒加载方式，所以取到的<code class=\"language-text\">src</code>为空，但是在微信客户端能够正常取到所有图片，所以对文章进行分析</p>\n<!-- More -->\n<h2>0x00 文章图片懒加载</h2>\n<p><code class=\"language-text\">Chrome</code>打开一篇微信公众号文章，审查元素，控制台输入<code class=\"language-text\">document.getElementsByTagName(&quot;img&quot;)</code>。可以看到正文图片的<code class=\"language-text\">img</code>标签定义了<code class=\"language-text\">img_loading</code>的<code class=\"language-text\">class</code>属性\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/71b916fd5fd5080508a83b9b02a662d7/3accd/1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAebnckg//8QAFhABAQEAAAAAAAAAAAAAAAAAEAFB/9oACAEBAAEFAo4f/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRABAAMBAQAAAAAAAAAAAAAAAQARMRBR/9oACAEBAAE/IcRW9lwahTzn/9oADAMBAAIAAwAAABBzz//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/EIf/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPxBn/8QAGhABAAMBAQEAAAAAAAAAAAAAAQARITFBcf/aAAgBAQABPxAWNT5AIFjXYp6rDJ2P017kavJ//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jsdelivr\"\n        title=\"jsdelivr\"\n        src=\"/static/71b916fd5fd5080508a83b9b02a662d7/1c72d/1.jpg\"\n        srcset=\"/static/71b916fd5fd5080508a83b9b02a662d7/a80bd/1.jpg 148w,\n/static/71b916fd5fd5080508a83b9b02a662d7/1c91a/1.jpg 295w,\n/static/71b916fd5fd5080508a83b9b02a662d7/1c72d/1.jpg 590w,\n/static/71b916fd5fd5080508a83b9b02a662d7/3accd/1.jpg 704w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>此时再看向该标签的<code class=\"language-text\">src</code>属性，是一张<code class=\"language-text\">base64</code>的<code class=\"language-text\">loading</code>图。这也就导致通常的做法是获取不到图片地址从而进行预览的\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2f97257bf0d7b1af4dfd01349d81b6e2/31be4/2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.756756756756756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAABABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAZYmwP/EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEAAQUCf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABUQAQEAAAAAAAAAAAAAAAAAABBB/9oACAEBAAE/IY//2gAMAwEAAgADAAAAEIgf/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8QJ//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/EGf/xAAYEAACAwAAAAAAAAAAAAAAAAABMQAQcf/aAAgBAQABPxApkCr/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jsdelivr\"\n        title=\"jsdelivr\"\n        src=\"/static/2f97257bf0d7b1af4dfd01349d81b6e2/1c72d/2.jpg\"\n        srcset=\"/static/2f97257bf0d7b1af4dfd01349d81b6e2/a80bd/2.jpg 148w,\n/static/2f97257bf0d7b1af4dfd01349d81b6e2/1c91a/2.jpg 295w,\n/static/2f97257bf0d7b1af4dfd01349d81b6e2/1c72d/2.jpg 590w,\n/static/2f97257bf0d7b1af4dfd01349d81b6e2/31be4/2.jpg 806w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>0x01 分析</h2>\n<p>然而在微信客户端可以正常预览，推测微信应该是在别的属性进行获取，定位到具体的标签看到文章中的<code class=\"language-text\">img</code>标签都定义了<code class=\"language-text\">data-src</code>、<code class=\"language-text\">data-type</code>属性（这是自定义属性，区分src，方便js调用）</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>img_loading<span class=\"token punctuation\">\"</span></span>\n<span class=\"token attr-name\">data-ratio</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0.53375<span class=\"token punctuation\">\"</span></span>\n<span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://mmbiz.qpic.cn/mmbiz_jpg/h5tEWrMy7mrq9iclTia1O8M2C5Se7nr5TgN6IibURS7YYpCSTwT0U5KUhOmGrxusN8iaQKrFDjtTBaMox6Dgp2Hfbg/640?wx_fmt=jpeg<span class=\"token punctuation\">\"</span></span>\n<span class=\"token attr-name\">data-type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jpeg<span class=\"token punctuation\">\"</span></span>\n<span class=\"token attr-name\">data-w</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>800<span class=\"token punctuation\">\"</span></span>\n<span class=\"token attr-name\">_width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>677px<span class=\"token punctuation\">\"</span></span>\n<span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==<span class=\"token punctuation\">\"</span></span><span class=\"token style-attr language-css\"><span class=\"token attr-name\">\n<span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">=\"</span><span class=\"token attr-value\"><span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 647px <span class=\"token important\">!important</span><span class=\"token punctuation\">;</span> <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 345.336px <span class=\"token important\">!important</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h2>0x02 解决</h2>\n<p>现在知道问题所在，针对<code class=\"language-text\">data-x</code>自定义属性可以通过<code class=\"language-text\">dataset</code>获得，之所以判断<code class=\"language-text\">dataset.type !== &quot;gif&quot;</code>是为了过滤掉<code class=\"language-text\">gif</code>，如果你想显示<code class=\"language-text\">gif</code>，可以去掉</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">wxImgClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> objs <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"img\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> imgs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> objs<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> dataset <span class=\"token operator\">=</span> objs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">.</span>src <span class=\"token operator\">&amp;&amp;</span> dataset<span class=\"token punctuation\">.</span>type <span class=\"token operator\">!==</span> <span class=\"token string\">\"gif\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> imgs<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">.</span>src<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n            objs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                window<span class=\"token punctuation\">.</span>xxxxxx<span class=\"token punctuation\">.</span><span class=\"token function\">openImage</span><span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>0x03 完整例子</h2>\n<p>可以在<code class=\"language-text\">webView</code>创建之时调用<code class=\"language-text\">addJavascriptInterface</code>进行监听</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">addJavascriptInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">JavascriptInterface</span><span class=\"token punctuation\">(</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"xxxxxx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JavascriptInterface</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">JavascriptInterface</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context <span class=\"token operator\">=</span> context<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@android</span><span class=\"token punctuation\">.</span>webkit<span class=\"token punctuation\">.</span><span class=\"token class-name\">JavascriptInterface</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">openImage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> imgs<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> index<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 预览图片操作</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在合适的时候注入<code class=\"language-text\">Js</code>，我这里是在<code class=\"language-text\">onPageFinished</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onPageFinished</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">WebView</span> view<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onPageFinished</span><span class=\"token punctuation\">(</span>view<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">addWXImgClickJs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addWXImgClickJs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 用\"javascript:(%s)()\"包住</span>\n    <span class=\"token class-name\">String</span> js <span class=\"token operator\">=</span> <span class=\"token string\">\"javascript:(function wxImgClick() {\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    let objs = document.getElementsByTagName(\\\"img\\\");\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    let imgs = [];\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    for (let i = 0; i &lt; objs.length; i++) {\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        let dataset = objs[i].dataset;\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        if (dataset.src &amp;&amp; dataset.type !== \\\"gif\\\") {\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"            let index = imgs.push(dataset.src) - 1;\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"            objs[i].onclick = function () {\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"                window.xxxxxx.openImage(imgs, index)\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"            }\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"        }\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"    }\\n\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"})()\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Build</span><span class=\"token punctuation\">.</span>VERSION<span class=\"token punctuation\">.</span>SDK_INT <span class=\"token operator\">>=</span> <span class=\"token class-name\">Build</span><span class=\"token punctuation\">.</span>VERSION_CODES<span class=\"token punctuation\">.</span>KITKAT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">evaluateJavascript</span><span class=\"token punctuation\">(</span>js<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">loadUrl</span><span class=\"token punctuation\">(</span>js<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>evaluateJavascript()是比loadUrl()更高效的注入Js的做法，还支持回调，推荐</p>\n</blockquote>","frontmatter":{"title":"Android WebView注入Js预览图片 - 微信公众号文章","date":"August 21, 2018","tags":["webView","js"],"categories":"Android"}}},"pageContext":{"slug":"/android-webview-js-yu-lan-tu-pian-zhi-wei-xin-wen-zhang/","previous":{"fields":{"slug":"/android-mvp-lifecycle-multi-presenter-damon/"},"frontmatter":{"title":"Android MVP - 拥有完整生命周期的Presenter，支持Multi P"}},"next":{"fields":{"slug":"/android-accessibilityservice-lian-shi-diao-yong/"},"frontmatter":{"title":"Android AccessibilityService - 链式结构"}}}},"staticQueryHashes":["2841359383"]}