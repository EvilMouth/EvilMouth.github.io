{"componentChunkName":"component---src-templates-blog-post-js","path":"/zi-dk-yi-glide-target-ui-xm-ds-td-textview-imagespan/","result":{"data":{"site":{"siteMetadata":{"title":"Evil Mouth","author":{"name":"Evil Mouth"}}},"markdownRemark":{"id":"7f849915-c48c-5a32-8ca6-ca598f3f4dd6","excerpt":"…","html":"<p>\b记录下实现下图效果的过程</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 524px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/03d5730ba9428f4bd018f8f30f1a7a91/98df1/1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.27027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHZki0V/8QAFxABAAMAAAAAAAAAAAAAAAAAAQAhMv/aAAgBAQABBQILdT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAADAQEAAAAAAAAAAAAAAAABAiEAEP/aAAgBAQAGPwJqctPP/8QAGRABAAIDAAAAAAAAAAAAAAAAAQAxEFGR/9oACAEBAAE/IUd1yFqLx//aAAwDAQACAAMAAAAQf8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAVEQEBAAAAAAAAAAAAAAAAAAAQQf/aAAgBAgEBPxCH/8QAGBABAAMBAAAAAAAAAAAAAAAAAQARIUH/2gAIAQEAAT8QDUxKUnFZkRQQ0CU52E//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/03d5730ba9428f4bd018f8f30f1a7a91/98df1/1.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/03d5730ba9428f4bd018f8f30f1a7a91/a80bd/1.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/03d5730ba9428f4bd018f8f30f1a7a91/1c91a/1.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/03d5730ba9428f4bd018f8f30f1a7a91/98df1/1.jpg 524w\"\n        sizes=\"(max-width: 524px) 100vw, 524px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<!-- More -->\n<h2>思考</h2>\n<p>原先这里只是一个<code class=\"language-text\">TextView</code>，并不需要显示图片，所以只需要将数据加入<code class=\"language-text\">/</code>间隔即可，然而现在需要每种属性展示对应的图片，并且该图片还需要支持<code class=\"language-text\">GIF</code>，本来想换成<code class=\"language-text\">ImageView+TextView列表来显示</code>，但需求还需要保持原先的一行限制，也就是文字过长时显示<code class=\"language-text\">...</code>，此时如果弃用单<code class=\"language-text\">TextView</code>的话还需要计算多个控件的宽度，所以还是继续使用<code class=\"language-text\">单TextView</code>方案方便，幸好<code class=\"language-text\">Span</code>可以很轻松的将文字替换成其它形式展示，所以实现起来应该很简单。</p>\n<h2>设计</h2>\n<p>整体思路就是下载图片得到<code class=\"language-text\">Drawable</code>，包装进<code class=\"language-text\">ImageSpan</code>，并将其添加到<code class=\"language-text\">TextView</code>的文本中</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> text <span class=\"token operator\">=</span> <span class=\"token function\">SpannableString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"  红色\"</span><span class=\"token punctuation\">)</span>\ntext<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token operator\">..</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token function\">ImageSpan</span><span class=\"token punctuation\">(</span>drawable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ntextView<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> text</code></pre></div>\n<h2>问题</h2>\n<p>因为要支持<code class=\"language-text\">GIF</code>，所以下载下来的<code class=\"language-text\">Drawable</code>如果是<code class=\"language-text\">Animatable</code>，还需要进行<code class=\"language-text\">start()</code>调用进行播放，并刷新<code class=\"language-text\">TextView</code>。</p>\n<p>有<code class=\"language-text\">start</code>自然要有<code class=\"language-text\">stop</code>，否则动图将会一直播放。</p>\n<p>原先我只是通过<code class=\"language-text\">Glide</code>来下载图片拿到<code class=\"language-text\">Drawable</code>，如下代码所示，那我还需要处理好生命周期，在页面关闭或者其它时机关闭动画，虽然现在挺多方式可以处理，但这种方式总是要外部介入，我想提供一个工具来实现这个功能并内部接管好生命周期的处理要如何实现呢？</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">Glide<span class=\"token punctuation\">.</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span>textView<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">asDrawable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span>SIZE<span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Glide Target</h2>\n<p><code class=\"language-text\">Glide</code>内部帮我们处理了生命周期的回调，自动并及时关闭图片加载请求，查看源码不难发现<code class=\"language-text\">Glide.into(imageView)</code>最后都是包装成一个<code class=\"language-text\">Target</code>，<code class=\"language-text\">Target</code>实现了<code class=\"language-text\">LifecycleListener</code>，所以完全可以自定义一个<code class=\"language-text\">Target</code>，借助<code class=\"language-text\">Glide</code>内部的生命周期管理来实现该功能。</p>\n<p>借鉴<code class=\"language-text\">Glide</code>的<code class=\"language-text\">ImageViewTarget</code>，看到其继承自<code class=\"language-text\">ViewTarget</code>，但弃用了，推荐使用<code class=\"language-text\">CustomViewTarget</code>，那就实现一个</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MyTarget <span class=\"token operator\">:</span> CustomViewTarget<span class=\"token operator\">&lt;</span>TextView<span class=\"token punctuation\">,</span> Drawable<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onResourceReady</span><span class=\"token punctuation\">(</span>resource<span class=\"token operator\">:</span> Drawable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// setSpan</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onResourceCleared</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// removeSpan</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// animatable.start()</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onStop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// animatable.stop()</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>现在就可以直接像平时<code class=\"language-text\">Glide.into(imageView)</code>一样直接调用了</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">Glide<span class=\"token punctuation\">.</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span>textView<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token function\">MyTarget</span><span class=\"token punctuation\">(</span>textView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>问题又来了</h2>\n<p>回看效果图，当有多张图片时，自然需求加载多个图片，那就是</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">urls<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>url <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n    Glide<span class=\"token punctuation\">.</span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span>textView<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token function\">MyTarget</span><span class=\"token punctuation\">(</span>textView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>当此时会发现只有最后一张图显示得出来，为什么呢？</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 378px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/e742329402d4a5fffec3adad4c9016e8/a5608/2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.324324324324326%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3JhcH//EABgQAAIDAAAAAAAAAAAAAAAAAAARAQIT/9oACAEBAAEFAlLs9D//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAACAwAAAAAAAAAAAAAAAAAAAhAhMv/aAAgBAQAGPwLQtx//xAAaEAACAwEBAAAAAAAAAAAAAAABEQAxUSFB/9oACAEBAAE/IbrLIDAUDzYK7P/aAAwDAQACAAMAAAAQcA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPxBn/8QAHBABAAICAwEAAAAAAAAAAAAAAQARITFRYaHh/9oACAEBAAE/EF6Qs641X2PU7Ve135AgFaGXmf/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2\"\n        title=\"2\"\n        src=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/e742329402d4a5fffec3adad4c9016e8/a5608/2.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/e742329402d4a5fffec3adad4c9016e8/a80bd/2.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/e742329402d4a5fffec3adad4c9016e8/1c91a/2.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/EvilMouth/EvilMouth.github.io@gh-pages/static/e742329402d4a5fffec3adad4c9016e8/a5608/2.jpg 378w\"\n        sizes=\"(max-width: 378px) 100vw, 378px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>原来<code class=\"language-text\">Glide.into</code>时，会将之前的请求给清除掉，而这个请求是绑定在<code class=\"language-text\">View</code>上的（下面源码），在这里就是绑定在了<code class=\"language-text\">TextView</code>上。</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"># <span class=\"token class-name\">CustomViewTarget</span>\n\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setRequest</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Request</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setTag</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setTag</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Object</span> tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  view<span class=\"token punctuation\">.</span><span class=\"token function\">setTag</span><span class=\"token punctuation\">(</span>VIEW_TAG_ID<span class=\"token punctuation\">,</span> tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Glide</code>这里的设计是<code class=\"language-text\">一个View对应一个Request</code>，思考下也合理，<code class=\"language-text\">一个ImageView</code>也就是为了展示<code class=\"language-text\">一张图片</code>，但我这里其实是<code class=\"language-text\">一个TextView对应多个Request</code>，那自然想到重写<code class=\"language-text\">setRequest</code>和<code class=\"language-text\">getRequest</code>，但发现<code class=\"language-text\">CustomViewTarget</code>的这两个方法修饰成了<code class=\"language-text\">final</code>，那只能跟<code class=\"language-text\">CustomViewTarget</code>说再见，跟他的爸爸<code class=\"language-text\">Target</code>说哈喽。</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// 将tag变成map，将request和url绑定</span>\n<span class=\"token keyword\">class</span> <span class=\"token function\">MyTarget</span><span class=\"token punctuation\">(</span>textView<span class=\"token operator\">:</span> TextView<span class=\"token punctuation\">,</span> url<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> Target<span class=\"token operator\">&lt;</span>Drawable<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">setRequest</span><span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> Request<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        textView<span class=\"token punctuation\">.</span><span class=\"token function\">getTag</span><span class=\"token punctuation\">(</span>VIEW_TAG_ID<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">let</span> <span class=\"token punctuation\">{</span>\n            it <span class=\"token keyword\">as</span> MutableMap<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Request<span class=\"token operator\">?</span><span class=\"token operator\">></span>\n            it<span class=\"token punctuation\">[</span>attr<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> request\n        <span class=\"token punctuation\">}</span> <span class=\"token operator\">?:</span> run <span class=\"token punctuation\">{</span>\n            textView<span class=\"token punctuation\">.</span><span class=\"token function\">setTag</span><span class=\"token punctuation\">(</span>VIEW_TAG_ID<span class=\"token punctuation\">,</span> <span class=\"token function\">mutableMapOf</span><span class=\"token punctuation\">(</span>url <span class=\"token keyword\">to</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Request<span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        textView<span class=\"token punctuation\">.</span><span class=\"token function\">getTag</span><span class=\"token punctuation\">(</span>VIEW_TAG_ID<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">let</span> <span class=\"token punctuation\">{</span>\n            it <span class=\"token keyword\">as</span> MutableMap<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Request<span class=\"token operator\">?</span><span class=\"token operator\">></span>\n            <span class=\"token keyword\">return</span> it<span class=\"token punctuation\">[</span>url<span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>剩下的就是一些细节处理了，包括拿到<code class=\"language-text\">Drawable</code>后如何定位到具体位置、<code class=\"language-text\">Animatable</code>播放如何刷新<code class=\"language-text\">TextView</code>、<code class=\"language-text\">ImageSpan</code>居中问题、<code class=\"language-text\">setText</code>时<code class=\"language-text\">BufferType</code>细节、占位图实现等。</p>\n<h2>总结</h2>\n<p>至此效果成功实现，外部只是要一行代码调用即可，不需要担心内存泄漏。</p>","frontmatter":{"title":"自定义 Glide Target 实现动态 TextView ImageSpan","date":"April 15, 2021","tags":["glide","custom target","textview","imagespan"],"categories":"Android"}}},"pageContext":{"slug":"/zi-dk-yi-glide-target-ui-xm-ds-td-textview-imagespan/","previous":{"fields":{"slug":"/android-do-mo-kuai-qi-dong-fang-an/"},"frontmatter":{"title":"Android 多模块启动方案"}},"next":null}},"staticQueryHashes":["2841359383"]}