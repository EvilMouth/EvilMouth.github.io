{"componentChunkName":"component---src-templates-blog-post-js","path":"/android-glide-cai-keng-ji/","result":{"data":{"site":{"siteMetadata":{"title":"Evil Mouth","author":{"name":"Evil Mouth"}}},"markdownRemark":{"id":"dd0b90db-f4a6-599e-8a0f-dda7f587c184","excerpt":"在最新的中，应该是开始吧，官方改变了的请求结构，许多 api 包括常用、、等都需要通过去配置，从而导致从迁移过来一路坎坷。所以官方为我们提供了让我们保留以前的流式调用，然而… 0x01 You cannot call Glide.get() in registerComponents(), use the…","html":"<p>在最新的<code class=\"language-text\">Glide 4.x</code>中，应该是<code class=\"language-text\">4.x</code>开始吧，官方改变了<code class=\"language-text\">Glide</code>的请求结构，许多 api 包括常用<code class=\"language-text\">centerCrop()</code>、<code class=\"language-text\">error()</code>、<code class=\"language-text\">placeholder()</code>等都需要通过<code class=\"language-text\">RequestOptions</code>去配置，从而导致从<code class=\"language-text\">3.x</code>迁移过来一路坎坷。所以官方为我们提供了<code class=\"language-text\">AppGlideModule</code>让我们保留以前的流式调用，然而…</p>\n<!-- More -->\n<h2>0x01 You cannot call Glide.get() in registerComponents(), use the provided Glide instance instead</h2>\n<p>这是什么鬼，明明 debug 包玩的好好的，打个 release 包就崩溃了，赶紧点进去看看</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Glide</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>glide <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Glide</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>glide <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">checkAndInitializeGlide</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> glide<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">checkAndInitializeGlide</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// In the thread running initGlide(), one or more classes may call Glide.get(context).</span>\n  <span class=\"token comment\">// Without this check, those calls could trigger infinite recursion.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInitializing<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"You cannot call Glide.get() in registerComponents(),\"</span>\n        <span class=\"token operator\">+</span> <span class=\"token string\">\" use the provided Glide instance instead\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  isInitializing <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">initializeGlide</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  isInitializing <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>调用<code class=\"language-text\">Glide.with()</code>会去拿单例，从而进入到<code class=\"language-text\">checkAndInitializeGlide</code>，报错的原因单例<code class=\"language-text\">glide=null</code>并且<code class=\"language-text\">isInitializing</code>，这东西怎么感觉不是我的问题。</p>\n<p>这个是<code class=\"language-text\">Glide</code>的初始化问题，是什么导致的呢？协程？同步锁？混淆？</p>\n<p>我一开始也是以为是混淆问题，所以赶紧去官网翻了下混淆文档\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d96cf78aa2d2b34c6baefa2efdfb8cd4/1982c/1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3QUD/8QAFhAAAwAAAAAAAAAAAAAAAAAAABAh/9oACAEBAAEFAir/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAADAQAAAAAAAAAAAAAAAAAAAREx/9oACAEBAAE/IY64QLD/2gAMAwEAAgADAAAAEHAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxAAAgEFAAAAAAAAAAAAAAAAAAEhETFBYZH/2gAIAQEAAT8QSJEvLNi6VKVz/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"/static/d96cf78aa2d2b34c6baefa2efdfb8cd4/1c72d/1.jpg\"\n        srcset=\"/static/d96cf78aa2d2b34c6baefa2efdfb8cd4/a80bd/1.jpg 148w,\n/static/d96cf78aa2d2b34c6baefa2efdfb8cd4/1c91a/1.jpg 295w,\n/static/d96cf78aa2d2b34c6baefa2efdfb8cd4/1c72d/1.jpg 590w,\n/static/d96cf78aa2d2b34c6baefa2efdfb8cd4/a8a14/1.jpg 885w,\n/static/d96cf78aa2d2b34c6baefa2efdfb8cd4/1982c/1.jpg 1176w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>嗯？没什么问题，一切按照文档配置，针对自定义的<code class=\"language-text\">AppGlideModule</code>也有防混，那么只能上 issue 看看了</p>\n<p><a href=\"https://github.com/bumptech/glide/issues/2780\">https://github.com/bumptech/glide/issues/2780</a></p>\n<p>貌似有人说了初始化的问题，要放到<code class=\"language-text\">Application.onCreate()</code>去初始化？？？看了整页都没有解决方案，那只好试一下了</p>\n<h2>0x02 GeneratedAppGlideModuleImpl is implemented incorrectly. If you’ve manually implemented this class, remove your implementation. The Annotation processor will generate a correct implementation.</h2>\n<p>？？？虽然也是崩溃，不过这次报的错不一样，不过好像能看出什么</p>\n<p><code class=\"language-text\">GeneratedAppGlideModuleImpl</code>这个东西就是我们自定义<code class=\"language-text\">AppGlideModule</code>会帮我们生成的代理类，这里说它实现错误了</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">GeneratedAppGlideModule</span> <span class=\"token function\">getAnnotationGeneratedGlideModules</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">GeneratedAppGlideModule</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">GeneratedAppGlideModule</span><span class=\"token punctuation\">></span></span> clazz <span class=\"token operator\">=</span>\n        <span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">GeneratedAppGlideModule</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token function\">forName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com.bumptech.glide.GeneratedAppGlideModuleImpl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredConstructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassNotFoundException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">isLoggable</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>WARN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">w</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Failed to find GeneratedAppGlideModule. You should include an\"</span>\n          <span class=\"token operator\">+</span> <span class=\"token string\">\" annotationProcessor compile dependency on com.github.bumptech.glide:compiler\"</span>\n          <span class=\"token operator\">+</span> <span class=\"token string\">\" in your application and a @GlideModule annotated AppGlideModule implementation or\"</span>\n          <span class=\"token operator\">+</span> <span class=\"token string\">\" LibraryGlideModules will be silently ignored\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// These exceptions can't be squashed across all versions of Android.</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InstantiationException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">throwIncorrectGlideModule</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IllegalAccessException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">throwIncorrectGlideModule</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">NoSuchMethodException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">throwIncorrectGlideModule</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InvocationTargetException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">throwIncorrectGlideModule</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">throwIncorrectGlideModule</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GeneratedAppGlideModuleImpl is implemented incorrectly.\"</span>\n      <span class=\"token operator\">+</span> <span class=\"token string\">\" If you've manually implemented this class, remove your implementation. The Annotation\"</span>\n      <span class=\"token operator\">+</span> <span class=\"token string\">\" processor will generate a correct implementation.\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>之所以报错就是找不到这个类，可以看到这里是通过<code class=\"language-text\">Class.forName</code>去查找的，既然找不到，说明很可能就是我一开始想的，被混淆了，赶紧打开<code class=\"language-text\">mapping.txt</code>看下</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">com.bumptech.glide.GeneratedAppGlideModuleImpl -&gt; gi:</code></pre></div>\n<p>果然。。。那就加个混淆</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-keep class com.bumptech.glide.GeneratedAppGlideModuleImpl { *; }</code></pre></div>\n<p>搞定，正常运行</p>","frontmatter":{"title":"Android Glide踩坑记 - AppGlideModule","date":"November 06, 2018","tags":["glide"],"categories":"Android"}}},"pageContext":{"slug":"/android-glide-cai-keng-ji/","previous":{"excerpt":"近期升级了一波，发现原先取消掉的点击阴影效果又出现了，以为是改了主题遍翻了翻改动，发现并没有可疑的修改导致，最后在源码里面发现真凶！ 0x00 support-27.1.1 此前的点击效果是通过设置进行取消 0x01 support-28.0.0 升级到 28.0.…","fields":{"slug":"/androidx-tablayout-ripple/"},"frontmatter":{"date":"October 24, 2018","title":"AndroidX TabLayout点击效果兼容问题","tags":["tabLayout"],"categories":"Android"}},"next":{"excerpt":"吐槽一下 Mist 客户端 mac 版，网络连接异常+是不是崩溃，不过智能合约开发起来真好玩\n这几天学习了智能合约开发语言 solidity…","fields":{"slug":"/blockchain-zhi-neng-he-yue-zhen-hao-wan/"},"frontmatter":{"date":"December 29, 2018","title":"智能合约真好玩","tags":["ethereum","contract"],"categories":"Blockchain"}}}},"staticQueryHashes":["2841359383"]}