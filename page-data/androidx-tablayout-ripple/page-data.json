{"componentChunkName":"component---src-templates-blog-post-js","path":"/androidx-tablayout-ripple/","result":{"data":{"site":{"siteMetadata":{"title":"Evil Mouth","author":{"name":"Evil Mouth"}}},"markdownRemark":{"id":"4e5b4840-c349-5c91-8463-b7c25cdac199","excerpt":"近期升级了一波，发现原先取消掉的点击阴影效果又出现了，以为是改了主题遍翻了翻改动，发现并没有可疑的修改导致，最后在源码里面发现真凶！ 0x00 support-27.1.1 此前的点击效果是通过设置进行取消 0x01 support-28.0.0 升级到28.0.…","html":"<p>近期升级了一波<code class=\"language-text\">AndroidX</code>，发现原先取消掉的<code class=\"language-text\">TabLayout</code>点击阴影效果又出现了，以为是改了主题遍翻了翻<code class=\"language-text\">git</code>改动，发现并没有可疑的修改导致，最后在源码里面发现真凶！</p>\n<!-- More -->\n<h2>0x00 support-27.1.1</h2>\n<p>此前<code class=\"language-text\">TabLayout</code>的点击效果是通过设置<code class=\"language-text\">app:tabBackground=&quot;@android:color/transparent&quot;</code>进行取消</p>\n<h2>0x01 support-28.0.0</h2>\n<p>升级到28.0.0后<code class=\"language-text\">TabLayout</code>加多了一个属性<code class=\"language-text\">app:tabRippleColor</code>，查看源码可知</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tabBackgroundResId <span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span><span class=\"token function\">getResourceId</span><span class=\"token punctuation\">(</span>styleable<span class=\"token punctuation\">.</span><span class=\"token class-name\">TabLayout_tabBackground</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tabRippleColorStateList <span class=\"token operator\">=</span> <span class=\"token class-name\">MaterialResources</span><span class=\"token punctuation\">.</span><span class=\"token function\">getColorStateList</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> styleable<span class=\"token punctuation\">.</span><span class=\"token class-name\">TabLayout_tabRippleColor</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateBackgroundDrawable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">TabLayout</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tabBackgroundResId <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>baseBackgroundDrawable <span class=\"token operator\">=</span> <span class=\"token class-name\">AppCompatResources</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDrawable</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TabLayout</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tabBackgroundResId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>baseBackgroundDrawable <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>baseBackgroundDrawable<span class=\"token punctuation\">.</span><span class=\"token function\">isStateful</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>baseBackgroundDrawable<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDrawableState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>baseBackgroundDrawable <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token class-name\">Drawable</span> contentDrawable <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GradientDrawable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GradientDrawable</span><span class=\"token punctuation\">)</span>contentDrawable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Object</span> background<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">TabLayout</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tabRippleColorStateList <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">GradientDrawable</span> maskDrawable <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GradientDrawable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        maskDrawable<span class=\"token punctuation\">.</span><span class=\"token function\">setCornerRadius</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.0E-5F</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        maskDrawable<span class=\"token punctuation\">.</span><span class=\"token function\">setColor</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ColorStateList</span> rippleColor <span class=\"token operator\">=</span> <span class=\"token class-name\">RippleUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">convertToRippleDrawableColor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TabLayout</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tabRippleColorStateList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>VERSION<span class=\"token punctuation\">.</span>SDK_INT <span class=\"token operator\">>=</span> <span class=\"token number\">21</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            background <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RippleDrawable</span><span class=\"token punctuation\">(</span>rippleColor<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TabLayout</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>unboundedRipple <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> contentDrawable<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TabLayout</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>unboundedRipple <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> maskDrawable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Drawable</span> rippleDrawable <span class=\"token operator\">=</span> <span class=\"token class-name\">DrawableCompat</span><span class=\"token punctuation\">.</span><span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>maskDrawable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">DrawableCompat</span><span class=\"token punctuation\">.</span><span class=\"token function\">setTintList</span><span class=\"token punctuation\">(</span>rippleDrawable<span class=\"token punctuation\">,</span> rippleColor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            background <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LayerDrawable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Drawable</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span>contentDrawable<span class=\"token punctuation\">,</span> rippleDrawable<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        background <span class=\"token operator\">=</span> contentDrawable<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token class-name\">ViewCompat</span><span class=\"token punctuation\">.</span><span class=\"token function\">setBackground</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Drawable</span><span class=\"token punctuation\">)</span>background<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">TabLayout</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">invalidate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">TabView</code>的<code class=\"language-text\">background</code>根据<code class=\"language-text\">tabRippleColorStateList</code>去包装从而实现点击效果，只要让<code class=\"language-text\">tabRippleColorStateList = null</code>即可取消，其中的<code class=\"language-text\">unboundedRipple</code>是设置水波纹效果的开关</p>\n<h2>0x03 兼容与结论</h2>\n<ul>\n<li>通过设置<code class=\"language-text\">app:tabRippleColor=&quot;@android:color/transparent&quot;</code>或者<code class=\"language-text\">TabLayout.setTabRippleColor(null);</code>即可取消点击阴影效果</li>\n<li>由于<code class=\"language-text\">AndroidX</code>基于<code class=\"language-text\">28.0.0</code>，所以出现兼容问题</li>\n</ul>","frontmatter":{"title":"AndroidX TabLayout点击效果兼容问题","date":"October 24, 2018","tags":["tabLayout"],"categories":"Android"}}},"pageContext":{"slug":"/androidx-tablayout-ripple/","previous":{"fields":{"slug":"/android-accessibilityservice-lian-shi-diao-yong/"},"frontmatter":{"title":"Android AccessibilityService - 链式结构"}},"next":{"fields":{"slug":"/android-glide-cai-keng-ji/"},"frontmatter":{"title":"Android Glide踩坑记 - AppGlideModule"}}}},"staticQueryHashes":["2841359383"]}